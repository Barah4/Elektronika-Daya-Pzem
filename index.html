<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PZEM-017 Energy Monitor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            text-align: center;
            padding: 20px;
        }
        h1 { margin-bottom: 10px; }
        .status { font-size: 0.9em; color: #666; margin-bottom: 30px; }
        .status span { font-weight: bold; }
        
        /* Container Grid */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }

        /* Kartu Data */
        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-5px); }
        
        .card h2 { font-size: 1.2em; color: #777; margin: 0; }
        .card .value { font-size: 2.5em; font-weight: bold; margin: 10px 0; }
        .card .unit { font-size: 0.6em; vertical-align: super; }

        /* Warna spesifik per tipe data */
        .voltage .value { color: #f1c40f; } /* Kuning */
        .current .value { color: #3498db; } /* Biru */
        .power .value { color: #e74c3c; }   /* Merah */
        .energy .value { color: #2ecc71; }  /* Hijau */

        /* Indikator Status Koneksi */
        .connected { color: green; }
        .disconnected { color: red; }
    </style>
</head>
<body>

    <h1>Monitoring Listrik PZEM-017</h1>
    <div class="status">
        Status MQTT: <span id="status-mqtt" class="disconnected">Disconnected</span> | 
        Update Terakhir: <span id="last-update">-</span>
    </div>

    <div class="dashboard">
        <div class="card voltage">
            <h2>Tegangan</h2>
            <div class="value"><span id="val-volt">0</span> <span class="unit">V</span></div>
        </div>

        <div class="card current">
            <h2>Arus</h2>
            <div class="value"><span id="val-amp">0</span> <span class="unit">A</span></div>
        </div>

        <div class="card power">
            <h2>Daya Aktif</h2>
            <div class="value"><span id="val-watt">0</span> <span class="unit">W</span></div>
        </div>

        <div class="card energy">
            <h2>Total Energi</h2>
            <div class="value"><span id="val-kwh">0</span> <span class="unit">kWh</span></div>
        </div>
    </div>

    <script>
        // --- KONFIGURASI ---
        // Browser HARUS menggunakan WebSocket Port (bukan 1883)
        // Untuk broker.emqx.io, port WebSocket adalah 8083
        const BROKER = "broker.emqx.io";
        const PORT = 8083; 
        const TOPIC = "kampus/pzem017/data";
        
        // Buat ID Client Random agar tidak bentrok dengan Python script
        const CLIENT_ID = "Web_Monitor_" + Math.random().toString(16).substr(2, 8);

        // Inisialisasi Client
        const client = new Paho.MQTT.Client(BROKER, PORT, CLIENT_ID);

        // Handler ketika koneksi terputus
        client.onConnectionLost = function (responseObject) {
            console.log("Koneksi Putus: " + responseObject.errorMessage);
            document.getElementById("status-mqtt").innerText = "Disconnected";
            document.getElementById("status-mqtt").className = "disconnected";
        };

        // Handler ketika pesan masuk
        client.onMessageArrived = function (message) {
            console.log("Data Masuk: " + message.payloadString);
            
            try {
                // Parsing JSON dari Python
                const data = JSON.parse(message.payloadString);

                // Update HTML (Pastikan key sesuai dengan JSON Python: tegangan, arus, daya, energi)
                document.getElementById("val-volt").innerText = data.tegangan;
                document.getElementById("val-amp").innerText = data.arus;
                document.getElementById("val-watt").innerText = data.daya;
                document.getElementById("val-kwh").innerText = data.energi;

                // Update Waktu
                const now = new Date();
                document.getElementById("last-update").innerText = now.toLocaleTimeString();

            } catch (e) {
                console.error("Error parsing JSON:", e);
            }
        };

        // Fungsi Koneksi
        function connectMQTT() {
            console.log("Menghubungkan ke " + BROKER + ":" + PORT);
            client.connect({
                onSuccess: function () {
                    console.log("Berhasil Terhubung!");
                    document.getElementById("status-mqtt").innerText = "Connected";
                    document.getElementById("status-mqtt").className = "connected";
                    
                    // Subscribe ke topik
                    client.subscribe(TOPIC);
                },
                onFailure: function (message) {
                    console.log("Gagal Konek: " + message.errorMessage);
                    document.getElementById("status-mqtt").innerText = "Error (Retrying...)";
                    setTimeout(connectMQTT, 5000); // Coba lagi setelah 5 detik
                }
            });
        }

        // Mulai koneksi saat halaman dimuat
        connectMQTT();

    </script>
</body>
</html>
